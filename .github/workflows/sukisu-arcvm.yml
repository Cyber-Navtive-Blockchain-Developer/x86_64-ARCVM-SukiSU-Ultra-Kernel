name: Chained ARCVM Kernel Build

on:
workflow_dispatch:
inputs:
kernelsu_variant:
description: ‘KernelSU variant to use’
required: false
default: ‘KernelSU’
type: choice
options:
- KernelSU
- SukiSU

jobs:
setup-and-patch:
name: Setup & Patch Kernel
runs-on: ubuntu-latest
outputs:
kernel_tar: ${{ steps.package.outputs.filename }}


steps:
  - name: Checkout workflow repo
    uses: actions/checkout@v3

  - name: Install Dependencies
    run: |
      sudo apt-get update
      sudo apt-get install -y git curl rsync

  - name: Clone Dependencies First
    run: |
      echo "[+] Cloning required repositories"
      if [ ! -d "kernel_patches" ]; then
        git clone https://github.com/Tools-cx-app/kernel_patches.git --depth=1
      else
        echo "kernel_patches already exists, skipping clone"
      fi
      echo "✓ All dependencies cloned successfully"

  - name: Clone ChromeOS ARCVM Kernel
    run: |
      if [ ! -d "kernel" ]; then
        git clone https://chromium.googlesource.com/chromiumos/third_party/kernel \
          --branch chromeos-5.10-arcvm --depth=1 kernel
      else
        echo "Kernel directory already exists, skipping clone"
      fi

  - name: Setup KernelSU
    working-directory: kernel
    run: |
      echo "[+] KernelSU setup via setup.sh"
      KERNEL_ROOT=$PWD

      if [ "${{ inputs.kernelsu_variant || 'KernelSU' }}" == "SukiSU" ]; then
        echo "[+] Installing SukiSU variant"
        curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s susfs-main
      else
        echo "[+] Installing Official KernelSU v0.9.5"
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s v0.9.5
      fi

      echo "✓ KernelSU setup done."

  - name: Add KernelSU symbols to ABI
    working-directory: kernel
    run: |
      echo "[+] Adding KernelSU symbols to ABI"
      SYMBOL_LIST=Module.symvers
      touch $SYMBOL_LIST
      if [ -f "KernelSU/kernel/export_symbol.txt" ]; then
        while IFS= read -r symbol; do
          [[ -z "$symbol" || "$symbol" =~ ^[[:space:]]*# ]] && continue
          symbol=$(echo "$symbol" | xargs)
          grep -qxF "0x00000000	$symbol	vmlinux	EXPORT_SYMBOL_GPL" $SYMBOL_LIST || \
            echo "0x00000000	$symbol	vmlinux	EXPORT_SYMBOL_GPL" >> $SYMBOL_LIST
        done < KernelSU/kernel/export_symbol.txt
      else
        echo "[-] WARNING: KernelSU export_symbol.txt not found!"
        ls -la KernelSU/kernel/ || true
      fi
      echo "✓ KernelSU symbols added: $(wc -l < $SYMBOL_LIST 2>/dev/null || echo '0') entries"

  - name: Verify KernelSU integration
    working-directory: kernel
    run: |
      echo "[+] Verifying KernelSU integration"
      [ ! -d "KernelSU" ] && echo "ERROR: KernelSU directory not found!" && exit 1
      [ ! -f "KernelSU/kernel/ksu.c" ] && echo "ERROR: KernelSU core files not found!" && exit 1
      grep -q "KernelSU" Makefile || echo "obj-\$(CONFIG_KSU) += KernelSU/" >> Makefile
      echo "✓ KernelSU integration verified"
      ls -la KernelSU/

  - name: Fix KernelSU Makefile for x86_64
    working-directory: kernel
    run: |
      echo "[+] Ensuring proper KernelSU Makefile integration"
      if [ ! -f "KernelSU/Makefile" ]; then
        echo "obj-\$(CONFIG_KSU) += kernel/" > KernelSU/Makefile
      fi
      if [ ! -f "KernelSU/kernel/Makefile" ]; then
        echo "WARNING: KernelSU kernel Makefile missing"
        ls -la KernelSU/kernel/ || true
      else
        echo "✓ KernelSU kernel Makefile exists"
      fi

  - name: Verify SUSFS Integration
    working-directory: kernel
    run: |
      echo "[+] Verifying SUSFS integration"
      [ -f "fs/susfs.c" ] && echo "✓ SUSFS core file exists" || echo "⚠ WARNING: fs/susfs.c not found"
      [ -f "include/linux/susfs.h" ] && echo "✓ SUSFS header exists" || echo "⚠ WARNING: include/linux/susfs.h not found"
      [ -f "fs/susfs_compat.c" ] && echo "✓ SUSFS compatibility stubs exist" || echo "⚠ WARNING: SUSFS compatibility stubs not found"
      if [ -f "KernelSU/kernel/Kconfig" ]; then
        grep -q "KSU_SUSFS" KernelSU/kernel/Kconfig && echo "✓ SUSFS Kconfig found in KernelSU" || echo "⚠ SUSFS Kconfig not found in KernelSU"
      fi
      echo "[+] SUSFS-related files:"
      find . -type f -name "*susfs*" 2>/dev/null | head -20 || true

  - name: Apply Hide Detection Patches
    working-directory: kernel
    run: |
      echo "[+] Applying hide detection patches"
      KERNEL_ROOT=$GITHUB_WORKSPACE/kernel
      cd $KERNEL_ROOT
      if [ "${{ inputs.kernelsu_variant || 'KernelSU' }}" == "SukiSU" ]; then
        if [ -f "$GITHUB_WORKSPACE/SukiSU_patch/69_hide_stuff.patch" ]; then
          patch -p1 -F3 < $GITHUB_WORKSPACE/SukiSU_patch/69_hide_stuff.patch || echo "[-] Patch already applied or failed"
        else
          echo "[-] SukiSU hide patch not found"
        fi
      else
        if [ -f "$GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch" ]; then
          patch -p1 -F3 < $GITHUB_WORKSPACE/kernel_patches/69_hide_stuff.patch || echo "[-] Patch already applied or failed"
        else
          echo "[-] KernelSU hide patch not found"
        fi
      fi

  - name: Bypass symbol protection checks
    working-directory: kernel
    run: |
      echo "[+] Bypassing symbol protection for custom modules"
      if [ -f "scripts/module.lds.S" ]; then
        sed -i 's/CONFIG_MODVERSIONS/CONFIG_MODVERSIONS_DISABLED/g' scripts/module.lds.S || true
      fi
      echo "✓ Symbol protection bypass complete"

  - name: Add SUSFS symbols to ABI
    working-directory: kernel
    run: |
      SYMBOL_LIST=Module.symvers
      touch $SYMBOL_LIST
      
      # Add symbols only if they don't already exist
      grep -q "susfs_is_boot_completed_triggered" $SYMBOL_LIST || cat >> $SYMBOL_LIST << 'EOF'
      0x00000000	susfs_is_boot_completed_triggered	vmlinux	EXPORT_SYMBOL_GPL
      0x00000000	susfs_is_current_ksu_domain	vmlinux	EXPORT_SYMBOL_GPL
      0x00000000	susfs_try_umount	vmlinux	EXPORT_SYMBOL_GPL
      0x00000000	susfs_ksu_sid	vmlinux	EXPORT_SYMBOL_GPL
      0x00000000	susfs_priv_app_sid	vmlinux	EXPORT_SYMBOL_GPL
      0x00000000	try_umount	vmlinux	EXPORT_SYMBOL_GPL
      EOF
      echo "✓ SUSFS symbols added to ABI"

  - name: Package Patched Kernel
    id: package
    run: |
      tar czf kernel-patched.tar.gz kernel
      echo "filename=kernel-patched.tar.gz" >> $GITHUB_OUTPUT

  - name: Upload Patched Kernel
    uses: actions/upload-artifact@v4
    with:
      name: kernel-patched
      path: kernel-patched.tar.gz


build-bzimage:
name: Build bzImage
runs-on: ubuntu-22.04
needs: setup-and-patch


steps:
  - name: Download Patched Kernel Artifact
    uses: actions/download-artifact@v4
    with:
      name: kernel-patched
      path: ./patched-kernel

  - name: Extract Patched Kernel
    run: |
      mkdir -p kernel
      tar xzf ./patched-kernel/kernel-patched.tar.gz --strip-components=1 -C .

  - name: Install Build Tools & LLVM 14
    run: |
      sudo apt-get update
      sudo apt-get install -y --no-install-recommends \
        bc bison build-essential ca-certificates flex git gnupg \
        libelf-dev libssl-dev lsb-release software-properties-common wget \
        libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu gzip \
        rsync python3 device-tree-compiler ccache
      sudo ln -sf /usr/bin/python3 /usr/bin/python

      LLVM_VERSION=14
      wget https://apt.llvm.org/llvm.sh
      chmod +x llvm.sh
      sudo ./llvm.sh $LLVM_VERSION
      rm llvm.sh

      for bin in clang clang++ ld.lld llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-objdump llvm-readelf; do
        sudo ln -sf /usr/bin/${bin}-${LLVM_VERSION} /usr/bin/$bin || true
      done

  - name: Configure & Build Kernel bzImage
    run: |
      cd kernel
      export CC="ccache clang"
      export HOSTCC="clang"
      export HOSTCXX="clang++"
      export LD=ld.lld
      export AR=llvm-ar
      export NM=llvm-nm
      export STRIP=llvm-strip
      export OBJCOPY=llvm-objcopy
      export OBJDUMP=llvm-objdump

      DEFCONFIG=arch/x86/configs/defconfig
      make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
      make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null

      scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
      scripts/config --file .config -e KSU -e KALLSYMS -e KALLSYMS_ALL
      scripts/config --file .config -e KSU_SUSFS -e KSU_SUSFS_HAS_MAGIC_MOUNT -e KSU_SUSFS_SUS_PATH -e KSU_SUSFS_SUS_MOUNT
      scripts/config --file .config -e KSU_SUSFS_TRY_UMOUNT -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
      scripts/config --file .config -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
      scripts/config --file .config -e KSU_SUSFS_SUS_KSTAT -d KSU_SUSFS_SUS_OVERLAYFS
      scripts/config --file .config -e KSU_SUSFS_SPOOF_UNAME -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
      scripts/config --file .config -e KSU_SUSFS_OPEN_REDIRECT -e KSU_SUSFS_ENABLE_LOG
      scripts/config --file .config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS -d KSU_SUSFS_SUS_SU

      make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) bzImage modules prepare-objtool

      echo "✓ Build complete!"
      ls -lh ${PWD}/arch/x86/boot/bzImage
      echo "file_path=${PWD}/arch/x86/boot/bzImage" >> $GITHUB_ENV

  - name: Upload bzImage
    uses: actions/upload-artifact@v4
    with:
      name: arcvm_bzimage
      path: kernel/arch/x86/boot/bzImage