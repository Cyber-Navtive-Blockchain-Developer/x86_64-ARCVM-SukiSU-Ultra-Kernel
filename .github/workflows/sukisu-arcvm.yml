name: Build ARCVM Kernel ‚Äì SukiSU Ultra + SUSFS
on:
  workflow_dispatch:

jobs:
  build:
    name: Build ChromeOS ARCVM Kernel
    runs-on: ubuntu-latest

    env:
      KERNEL_BRANCH: chromeos-5.10-arcvm
      KERNEL_REPO: https://chromium.googlesource.com/chromiumos/third_party/kernel
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      LLVM: 1
      ARCH: x86_64

    steps:
    # ---------------------------------------------------------
    # üì¶ SYSTEM PREP + LLVM
    # ---------------------------------------------------------
    - name: Install Dependencies & LLVM
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ca-certificates flex git gnupg \
          libelf-dev libssl-dev lsb-release software-properties-common wget \
          libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
          rsync python3 device-tree-compiler

        sudo ln -sf /usr/bin/python3 /usr/bin/python

        LLVM_VERSION=14
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh $LLVM_VERSION
        rm llvm.sh

        for bin in clang clang++ ld.lld llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-objdump llvm-readelf; do
          sudo ln -sf /usr/bin/${bin}-${LLVM_VERSION} /usr/bin/$bin
        done

    - name: Setup ccache
      run: |
        mkdir -p $CCACHE_DIR
        ccache -M 10G
        echo "Using ccache at $CCACHE_DIR"

    - name: Restore ccache
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: arcvm-ccache-${{ github.sha }}
        restore-keys: arcvm-ccache-

    # ---------------------------------------------------------
    # üì• FETCH KERNEL SOURCE
    # ---------------------------------------------------------
    - name: Clone ChromeOS ARCVM Kernel
      run: |
        git clone $KERNEL_REPO --branch $KERNEL_BRANCH --depth=1 kernel
        echo "Kernel cloned."

    # ---------------------------------------------------------
    # ‚öôÔ∏è APPLY KernelSU + SukiSU Ultra + SUSFS
    # ---------------------------------------------------------
    - name: Apply KernelSU
      run: |
        git clone https://github.com/tiann/KernelSU.git -b main kernel/ksu
        bash kernel/ksu/kernel/setup.sh

    - name: Apply SukiSU Ultra
      run: |
        curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh \
          | bash -s susfs-main

    - name: Apply SUSFS (simonpunk)
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git kernel/susfs
        cp -r kernel/susfs/kernel_patches/fs/* kernel/fs/
        cp -r kernel/susfs/kernel_patches/include/linux/* kernel/include/linux/
        patch -p1 < kernel/susfs/kernel_patches/50_add_susfs_in_gki-android14-5.10.patch || true

    # ---------------------------------------------------------
    # üî® BUILD KERNEL (Clang/LLVM + KernelSU + SUSFS)
    # ---------------------------------------------------------
    - name: Build Kernel
      working-directory: kernel
      env:
        KERNEL_IMAGE_NAME: ${{ matrix.kernel_image_name }}
        ARCH: ${{ matrix.arch }}
      run: |
        set -a && . ${{ matrix.build_config }}; set +a
        export DEFCONFIG=${{ matrix.defconfig }}

        if [ ! -z ${{ vars.EXPECTED_SIZE }} ] && [ ! -z ${{ vars.EXPECTED_HASH }} ]; then
          export KSU_EXPECTED_SIZE=${{ vars.EXPECTED_SIZE }}
          export KSU_EXPECTED_HASH=${{ vars.EXPECTED_HASH }}
        fi

        export CC="ccache clang"
        export HOSTCC="clang"
        export HOSTCXX="clang++"
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export STRIP=llvm-strip
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump

        echo "[+] Running mrproper"
        make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} mrproper
        
        echo "[+] Loading defconfig: ${DEFCONFIG}"
        make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} ${DEFCONFIG} < /dev/null
        
        echo "[+] Configuring LTO"
        scripts/config --file .config -e LTO_CLANG -d LTO_NONE -e LTO_CLANG_THIN -d LTO_CLANG_FULL -e THINLTO
        
        echo "[+] Configuring KernelSU"
        scripts/config --file .config -e KSU
        scripts/config --file .config -e KALLSYMS
        scripts/config --file .config -e KALLSYMS_ALL
        
        echo "[+] Configuring SUSFS"
        scripts/config --file .config -e KSU_SUSFS
        scripts/config --file .config -e KSU_SUSFS_HAS_MAGIC_MOUNT
        scripts/config --file .config -e KSU_SUSFS_SUS_PATH
        scripts/config --file .config -e KSU_SUSFS_SUS_MOUNT
        scripts/config --file .config -e KSU_SUSFS_TRY_UMOUNT
        scripts/config --file .config -e KSU_SUSFS_AUTO_ADD_SUS_KSU_DEFAULT_MOUNT
        scripts/config --file .config -e KSU_SUSFS_AUTO_ADD_SUS_BIND_MOUNT
        scripts/config --file .config -e KSU_SUSFS_AUTO_ADD_TRY_UMOUNT_FOR_BIND_MOUNT
        scripts/config --file .config -e KSU_SUSFS_SUS_KSTAT
        scripts/config --file .config -d KSU_SUSFS_SUS_OVERLAYFS
        scripts/config --file .config -e KSU_SUSFS_SPOOF_UNAME
        scripts/config --file .config -e KSU_SUSFS_SPOOF_CMDLINE_OR_BOOTCONFIG
        scripts/config --file .config -e KSU_SUSFS_OPEN_REDIRECT
        scripts/config --file .config -e KSU_SUSFS_ENABLE_LOG
        scripts/config --file .config -e KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS
        scripts/config --file .config -d KSU_SUSFS_SUS_SU
        
        echo "[+] Starting kernel build with $(nproc) threads"
        echo "[+] Building: ${KERNEL_IMAGE_NAME}, modules, and prepare-objtool"
        make LLVM=1 LLVM_IAS=1 DEPMOD=depmod DTC=dtc O=${PWD} -j$(nproc) ${KERNEL_IMAGE_NAME} modules prepare-objtool
        
        echo "‚úì Build complete!"
        ls -lh ${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}
        echo "file_path=${PWD}/arch/${ARCH}/boot/${KERNEL_IMAGE_NAME}" >> $GITHUB_ENV

    # ---------------------------------------------------------
    # üì¶ PACKAGE bzImage
    # ---------------------------------------------------------
    - name: Package Output
      run: |
        mkdir -p output
        cp kernel/arch/x86/boot/bzImage output/
        echo "bzImage packaged."

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: arcvm_sukisu_ultra_kernel
        path: output/*