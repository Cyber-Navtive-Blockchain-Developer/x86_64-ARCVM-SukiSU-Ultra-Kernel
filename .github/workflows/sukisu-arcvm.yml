name: Build ARCVM Kernel ‚Äì SukiSU Ultra + SUSFS
on:
  workflow_dispatch:

jobs:
  build:
    name: Build ChromeOS ARCVM Kernel
    runs-on: ubuntu-latest

    env:
      KERNEL_BRANCH: chromeos-5.10-arcvm
      KERNEL_REPO: https://chromium.googlesource.com/chromiumos/third_party/kernel
      CCACHE_DIR: ${{ github.workspace }}/.ccache
      LLVM: 1
      ARCH: x86_64

    steps:
    # ---------------------------------------------------------
    # üì¶ SYSTEM PREP + LLVM
    # ---------------------------------------------------------
    - name: Install Dependencies & LLVM
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          bc bison build-essential ca-certificates flex git gnupg \
          libelf-dev libssl-dev lsb-release software-properties-common wget \
          libncurses-dev binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu nuget gzip \
          rsync python3 device-tree-compiler

        # Make python3 default
        sudo ln -sf /usr/bin/python3 /usr/bin/python

        # Install LLVM 14
        LLVM_VERSION=14
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh $LLVM_VERSION
        rm llvm.sh

        # Symlink LLVM binaries to /usr/bin
        for bin in clang clang++ ld.lld llvm-ar llvm-nm llvm-strip llvm-objcopy llvm-objdump llvm-readelf; do
          sudo ln -sf /usr/bin/${bin}-${LLVM_VERSION} /usr/bin/$bin
        done

    - name: Setup ccache
      run: |
        mkdir -p $CCACHE_DIR
        ccache -M 10G
        echo "Using ccache at $CCACHE_DIR"

    - name: Restore ccache
      uses: actions/cache@v3
      with:
        path: ${{ env.CCACHE_DIR }}
        key: arcvm-ccache-${{ github.sha }}
        restore-keys: arcvm-ccache-

    # ---------------------------------------------------------
    # üì• FETCH KERNEL SOURCE
    # ---------------------------------------------------------
    - name: Clone ChromeOS ARCVM Kernel
      run: |
        git clone $KERNEL_REPO --branch $KERNEL_BRANCH --depth=1 kernel
        echo "Kernel cloned."

    # ---------------------------------------------------------
    # ‚öôÔ∏è APPLY KernelSU + SukiSU Ultra + SUSFS
    # ---------------------------------------------------------
    - name: Apply KernelSU
      run: |
        git clone https://github.com/tiann/KernelSU.git -b main kernel/ksu
        bash kernel/ksu/kernel/setup.sh

    - name: Apply SukiSU Ultra
      run: |
        curl -LSs https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/susfs-main/kernel/setup.sh \
          | bash -s susfs-main

    - name: Apply SUSFS (simonpunk)
      run: |
        git clone https://gitlab.com/simonpunk/susfs4ksu.git kernel/susfs
        cp -r kernel/susfs/kernel_patches/fs/* kernel/fs/
        cp -r kernel/susfs/kernel_patches/include/linux/* kernel/include/linux/
        patch -p1 < kernel/susfs/kernel_patches/50_add_susfs_in_gki-android14-5.10.patch || true

    # ---------------------------------------------------------
    # üß© CONFIGURE DEFCONFIG (x86_64)
    # ---------------------------------------------------------
    - name: Update x86_64 kernel config
      run: |
        DEFCONFIG=kernel/arch/x86/configs/defconfig
        echo "CONFIG_KSU=y" >> $DEFCONFIG
        echo "CONFIG_KSU_MANUAL_HOOK=y" >> $DEFCONFIG
        echo "CONFIG_KSU_SUSFS=y" >> $DEFCONFIG
        echo "CONFIG_KSU_SUSFS_ENABLE_LOG=y" >> $DEFCONFIG
        echo "CONFIG_KSU_SUSFS_HIDE_KSU_SUSFS_SYMBOLS=y" >> $DEFCONFIG
        echo "CONFIG_KSU_SUSFS_TRY_UMOUNT=y" >> $DEFCONFIG
        echo "CONFIG_OVERLAY_FS=y" >> $DEFCONFIG
        echo "CONFIG_ZRAM=y" >> $DEFCONFIG
        echo "CONFIG_CRYPTO_LZ4=y" >> $DEFCONFIG

    # ---------------------------------------------------------
    # üî® BUILD KERNEL (Clang/LLVM)
    # ---------------------------------------------------------
    - name: Build ChromeOS ARCVM Kernel (bzImage)
      run: |
        cd kernel

        export CC="ccache clang"
        export HOSTCC="clang"
        export HOSTCXX="clang++"
        export LD=ld.lld
        export AR=llvm-ar
        export NM=llvm-nm
        export STRIP=llvm-strip
        export OBJCOPY=llvm-objcopy
        export OBJDUMP=llvm-objdump

        make defconfig ARCH=x86_64
        make -j$(nproc) ARCH=x86_64 LLVM=1 bzImage

        echo "Build finished."

    # ---------------------------------------------------------
    # üì¶ PACKAGE bzImage
    # ---------------------------------------------------------
    - name: Package Output
      run: |
        mkdir -p output
        cp kernel/arch/x86/boot/bzImage output/
        echo "bzImage packaged."

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: arcvm_sukisu_ultra_kernel
        path: output/*